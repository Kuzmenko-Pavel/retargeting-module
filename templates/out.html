<html>
<head>
<META http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="robots" content="nofollow" />
<script>
//IE FIX
if (!Date.now) {
    Date.now = function() { return new Date().getTime(); }
}
if (!('indexOf' in Array.prototype)) {
    Array.prototype.indexOf= function(find, i /*opt*/) {
        if (i===undefined) i= 0;
        if (i<0) i+= this.length;
        if (i<0) i= 0;
        for (var n= this.length; i<n; i++)
            if (i in this && this[i]===find)
                return i;
        return -1;
    };
}
//IE END FIX
function Test(){
    var test = 'test';
    try {
        JSON.parse("{}");
        localStorage.setItem(test, test);
        localStorage.removeItem(test);
        return true;
    } catch(e) {
        console.log(e);
        return false;
    }
};
function RetargetingOffers(){
    initialValues = new Object({});
    initialValues.add = RetargetingOffers.add;
    initialValues.get = RetargetingOffers.get;
    return(initialValues);
};

RetargetingOffers.add = function(guid, arg1, arg2, arg3){
    if (arg1 && arg2 && arg3)
    {
        this[guid] = [arg1, arg2, arg3];
    }
    if( Object.prototype.toString.call( arg1 ) === '[object Array]' ) {
        this[guid] = [arg1[0], arg1[1], arg1[2]];
    }
};

RetargetingOffers.get = function(){
    keys = [];
    time = Math.floor(Date.now());
    for(var key in this) {
        var value = this[key];
        if (value[0] > time)
        {
            keys.push(key +"~"+ this[key][2]+"~"+this[key][1]);
        }
    }
    return keys.join(";");
};

function UserHistory(){
	this.retargeting = new RetargetingOffers();
    this.load = UserHistory.load;
    this.save = UserHistory.save;
};

UserHistory.load = function(){
    if (Test() === true)
    {
        for (key in this)
        {
            if (typeof(this[key]) != 'function')
            {
                var history_name = key;
                var retrievedObject = JSON.parse(localStorage.getItem(history_name));
                for ( key in retrievedObject)
                {   
                    console.log(history_name, key, retrievedObject[key]);
                    this[history_name].add(key, retrievedObject[key]);
                }
            }
        }
        return true;
    }
    return false;
};
UserHistory.save = function(){
    if (Test() === true)
    {
        for (key in this)
        {
            if (typeof(this[key]) != 'function')
            {
                localStorage.setItem(key, JSON.stringify(this[key]));
            }
        }
        return true;
    }
    return false;
};
var uh = new UserHistory();
uh.load();
uh.retargeting.add('%1%...%3%', Math.floor(Date.now())+%2%,'%3%','%4%');
uh.save();
</script>
</head>
<body>
</body>
</html>
